<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <link rel="shortcut icon" href="/favicon.ico">
    <link rel="apple-touch-icon" href="img/icons/apple-touch-icon.png">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#000000">
    <meta name="description" content="Find the right photographer with ease.">
    <base href="/">
    <!--
      manifest.json provides metadata used when your web app is installed on a
      user's mobile device or desktop. See https://developers.google.com/web/fundamentals/web-app-manifest/
    -->
    <link rel="manifest" href="/manifest.json">
    <!--
      Notice the use of  in the tags above.
      It will be replaced with the URL of the `public` folder during the build.
      Only files inside the `public` folder can be referenced from the HTML.

      Unlike "/favicon.ico" or "favicon.ico", "/favicon.ico" will
      work correctly both with client-side routing and a non-root public URL.
      Learn how to configure a non-root public URL by running `npm run build`.
    -->
    <title>Photo market</title>
    <link rel="stylesheet" href="/css/styles.css">
    <link rel="stylesheet" href="/css/header.css">
    <link rel="stylesheet" href="/css/footer.css">
    <link rel="stylesheet" href="/css/chat.css">
    <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,700&display=swap&subset=cyrillic"
          rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.css">
</head>
<body>
<noscript>You need to enable JavaScript to run this app.</noscript>
<!-- Will be used as a mounting point in ReactJS -->
<div id="root">

    <header class="header-desktop">
        <a href="/" class="hw-logo">
            <img height="17px" width="197px" src="/img/logo.png" alt="Logo">
        </a>
        <nav class="site-nav">
            <ul>
                <li><a href="/signup.html">Sign up</a></li>
                <li><a href="/login.html">Login</a></li>
            </ul>
        </nav>
    </header>

    <header class="header-mobile">
        <div class="hw-logo">
            <button type="button" class="menu-button" onclick="openMenu(this)">
                <img height="17px" src="/img/logo.png" alt="Logo">
                <img class="arrow" src="/img/down-arrow.svg" alt="">
            </button>
        </div>
        <nav id="header-mobile-links">
            <ul>
                <li><a href="/">Home</a></li>
                <li><a href="/join">Join as a photographer</a></li>
                <li><a href="/signup.html">Sign up</a></li>
                <li><a href="/login">Log in</a></li>
            </ul>
        </nav>
    </header>

    <main class="messaging">
        <div class="chat">
            <div class="left-bar">
                <div class="search">
                    <label>
                        <input type="search" placeholder="Search">
                    </label>
                </div>

                <div class="dialogs">
                    <ul>
                        <li class="active">
                            <img alt="Avatar" class="small-avatar"
                                 src="/img/michael-dam-mEZ3PoFGs_k-unsplash.jpg"
                                 width="50px" height="50px">
                            <div>
                                <div class="name-and-date">
                                    <div class="name">Steven Johnson</div>
                                    <div class="last-message-time">9:18 AM</div>
                                </div>
                                <div class="last-message">
                                    Last message...
                                </div>
                            </div>
                        </li>
                        <li>
                            <img alt="Avatar" class="small-avatar"
                                 src="/img/michael-dam-mEZ3PoFGs_k-unsplash.jpg"
                                 width="50px" height="50px">
                            <div>
                                <div class="name-and-date">
                                    <div class="name">Steven Johnson</div>
                                    <div class="last-message-time">9:18 AM</div>
                                </div>
                                <div class="last-message">
                                    Last message...
                                </div>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>

            <div class="right-bar">
                <div class="recipient-info">
                    <img alt="Avatar"
                         class="small-avatar"
                         src="/img/michael-dam-mEZ3PoFGs_k-unsplash.jpg"
                         width="40px"
                         height="40px">
                    <div>
                        <div class="name">Steven Johnson</div>
                        <div class="last-seen">last seen: 11 minutes ago</div>
                    </div>
                </div>

                <div class="im-messages-container">
                    <div class="messages" id="messages">
                        <div style="flex-grow: 1;"></div>
                        <div class="outcoming">
                            <div class="message">
                                Lorem ipsum dolor sit amet, consectetur adipiscing elit.
                                Cras ac vestibulum est. Cras vestibulum sagittis molestie.
                            </div>
                            <div class="message-info">
                                12:34 AM, read
                            </div>
                        </div>
                        <div class="incoming">
                            <div class="message">
                                Maecenas luctus, arcu quis mollis blandit, lorem lectus cursus enim,
                                vel suscipit elit ipsum ullamcorper purus.
                            </div>
                            <div class="message-info">
                                12:34 AM, read
                            </div>
                        </div>
                        <div class="incoming">
                            <div class="message">
                                Lorem ipsum dolor sit amet, consectetur adipiscing elit.
                                Cras ac vestibulum est. Cras vestibulum sagittis molestie.
                                Fusce feugiat porttitor turpis. Fusce tincidunt sollicitudin magna.
                                Maecenas luctus, arcu quis mollis blandit, lorem lectus cursus enim,
                                vel suscipit elit ipsum ullamcorper purus.
                            </div>
                            <div class="message-info">
                                12:34 AM, read
                            </div>
                        </div>
                        <div class="incoming">
                            <div class="message">
                                Lorem ipsum dolor sit amet, consectetur adipiscing elit.
                                Cras ac vestibulum est. Cras vestibulum sagittis molestie.
                                Vivamus semper mi sit amet odio ornare, a fermentum ex placerat.
                                Curabitur at est quam. Cras ut molestie leo. Sed a convallis libero.
                                Aenean faucibus nisi nec dolor consequat dignissim. Duis ut volutpat arcu.
                                Interdum et malesuada fames ac ante ipsum primis in faucibus.
                                Fusce feugiat porttitor turpis. Fusce tincidunt sollicitudin magna.
                                Maecenas luctus, arcu quis mollis blandit, lorem lectus cursus enim,
                                vel suscipit elit ipsum ullamcorper purus.
                            </div>
                            <div class="message-info">
                                12:34 AM, read
                            </div>
                        </div>
                        <div class="outcoming">
                            <div class="message">
                                Lorem ipsum dolor sit amet
                            </div>
                            <div class="message-info">
                                12:34 AM, read
                            </div>
                        </div>
                    </div>
                </div>

                <div class="input-bar">
                    <button class="attach">
                        <i class="fas fa-paperclip"></i>
                    </button>
                    <label style="display:none">
                        <textarea name="text" placeholder="Write a message..."></textarea>
                    </label>
                    <div class="text-area"
                         contenteditable="true"
                         onkeydown="onKeyDown(event, this)"
                         onfocusout="onFocusOut(event, this)"
                         data-placeholder="Write a message..."></div>
                    <button>
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </main>

    <footer class="footer-main">
        <ul class="footer-links">
            <li><a href="/about-us">About us</a></li>
            <li><a href="/about-us">Contact us</a></li>
            <li><a href="/sitemap">Site map</a></li>
            <li><a href="/legal">Terms & Conditions</a></li>
            <li><a href="/privacy">Privacy Policy</a></li>
        </ul>
        <div>&copy; 2019 Photo Market, Inc.</div>
    </footer>
</div>
<script src="/js/script.js"></script>
<script>
    let socket;
    let clientInfo = {
        clientID: undefined,
    };

    document.querySelector('div[contenteditable="true"]').addEventListener("paste", (e) => {
        // cancel paste
        e.preventDefault();

        // get text representation of clipboard
        const text = (e.originalEvent || e).clipboardData.getData('text/plain');

        const trimmedText = text.substr(0, 1000);

        // insert text manually
        document.execCommand("insertText", false, trimmedText);
    });

    function onKeyDown(event, el) {
        if (event.keyCode === 13 && !event.shiftKey) {
            // console.log(event);
            event.preventDefault();

            const text = el.innerText;
            if (text.trim() === '') return;

            if (socket.readyState === 1) { // OPEN
                sendMessage(text);
                // Reset input field
                el.innerText = '';
            }
        }
    }

    function onFocusOut(event, el) {
        if (el.innerText.trim() === '') {
            el.innerHTML = '';
        }
    }

    function convertToPlaintext(el) {
        let textContent = el.textContent;
        el.innerHTML = "";
        el.textContent = textContent;
    }

    function sendMessage(message) {
        const data = {
            clientID: clientInfo.clientID,
            date: Date.now(),
            type: "message",
            text: message
        };
        console.log('Sending...');
        console.log(data);
        socket.send(JSON.stringify(data));
    }

    window.onload = () => {
        const imElement = document.getElementById('messages');
        imElement.scrollTop = imElement.scrollHeight;

        socket = new WebSocket("ws://localhost:9999/chat");

        // connection established
        socket.onopen = function (e) {
            console.log("[open] Connection established");
            console.log(e);
        };

        // data received
        socket.onmessage = function (event) {
            console.log(`[message] Data received from server: ${event.data}`);
            const msg = JSON.parse(event.data);
            switch (msg.type) {
                case 'init':
                    clientInfo.clientID = msg.clientID;
                    break;
                case 'message':
                    console.log('incoming message: ' + msg.text);
                    break;
                case 'user_list':
                    // new users list
                    break;
            }
        };

        // connection closed
        socket.onclose = function (event) {
            if (event.wasClean) {
                console.log(`[close] Connection closed cleanly, code=${event.code} reason=${event.reason}`);
            } else {
                // e.g. server process killed or network down
                // event.code is usually 1006 in this case
                console.log('[close] Connection died');
            }
        };

        // websocket error
        socket.onerror = function (error) {
            console.log(`[error] ${error.message}`);
        };
    }
</script>
</body>
</html>